# GitLab CI/CD Pipeline for Formalogix Landing Page
# Deploys Astro static site to Cloudflare Pages

stages:
  - build
  - deploy

variables:
  NODE_ENV: production
  npm_config_cache: "$CI_PROJECT_DIR/.npm"

cache:
  key:
    files:
      - package-lock.json
  paths:
    - node_modules/
    - .npm/

build:
  stage: build
  image: node:23-alpine
  before_script:
    - echo "Building for branch $CI_COMMIT_REF_NAME"
    - node --version
    - npm --version
  script:
    - |
      if [ "$CI_COMMIT_REF_NAME" = "main" ]; then
        export PUBLIC_API_URL="$PUBLIC_API_URL_PROD"
        export PUBLIC_UMAMI_WEBSITE_ID="$PUBLIC_UMAMI_WEBSITE_ID_PROD"
        echo "Building for PRODUCTION environment"
      else
        export PUBLIC_API_URL="$PUBLIC_API_URL_PREVIEW"
        export PUBLIC_UMAMI_WEBSITE_ID="$PUBLIC_UMAMI_WEBSITE_ID_PREVIEW"
        echo "Building for PREVIEW environment (branch: $CI_COMMIT_REF_NAME)"
      fi
    - npm ci --prefer-offline --no-audit
    - npm run build
    - ls -lh dist/
    - du -sh dist/
  artifacts:
    paths:
      - dist/
    expire_in: 1 day
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "dev"'
    - if: '$CI_COMMIT_BRANCH =~ /^feature\/.*/'
    - if: '$CI_COMMIT_BRANCH =~ /^fix\/.*/'

build:api:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:v1.9.0-debug
    entrypoint: [""]
  script:
    - echo "Building API for branch $CI_COMMIT_REF_NAME"
    - |
      if [ "$CI_COMMIT_BRANCH" = "main" ]; then
        export IMAGE_TAG="v${API_VERSION}-${CI_COMMIT_SHORT_SHA}"
        export LATEST_TAG="latest"
        echo "Building PRODUCTION image with tag: $IMAGE_TAG"
      else
        export IMAGE_TAG="dev-${CI_COMMIT_SHORT_SHA}"
        export LATEST_TAG="dev-latest"
        echo "Building PREVIEW image with tag: $IMAGE_TAG"
      fi
    - export FULL_IMAGE_NAME="${DOCKER_REGISTRY}/${DOCKER_REGISTRY_IMAGE}"
    - echo "Full image name ${FULL_IMAGE_NAME}:${IMAGE_TAG}"
    - mkdir -p /kaniko/.docker
    - echo "{\"auths\":{\"${DOCKER_REGISTRY}\":{\"auth\":\"$(printf "%s:%s" "${DOCKER_REGISTRY_USER}" "${DOCKER_REGISTRY_PASSWORD}" | base64 | tr -d '\n')\"}}}" > /kaniko/.docker/config.json
    - |
      /kaniko/executor \
        --context "${CI_PROJECT_DIR}/api-server-go" \
        --dockerfile "${CI_PROJECT_DIR}/api-server-go/deployments/docker/Dockerfile" \
        --destination "${FULL_IMAGE_NAME}:${IMAGE_TAG}" \
        --destination "${FULL_IMAGE_NAME}:${LATEST_TAG}" \
        --skip-tls-verify \
        --cache=true \
        --cache-ttl=24h
    - echo "SUCCESS - Image built and pushed"
    - echo "Image ${FULL_IMAGE_NAME}:${IMAGE_TAG}"
  rules:
    - if: '$CI_COMMIT_BRANCH'
      changes:
        - api-server-go/**/*
        - .gitlab-ci.yml

deploy:production:
  stage: deploy
  image: node:23-alpine
  script:
    - echo "Deploying to PRODUCTION (formalogix.com)"
    - npx wrangler@latest pages deploy dist/ --project-name="$CLOUDFLARE_PROJECT_NAME" --branch=main --commit-dirty=true
    - echo "SUCCESS - Production deployment complete!"
    - echo "URL https://formalogix.com"
  environment:
    name: production
    url: https://formalogix.com
  dependencies:
    - build
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

deploy:preview:
  stage: deploy
  image: node:23-alpine
  before_script:
    - apk add --no-cache curl
    - npm config set fetch-retry-mintimeout 20000
    - npm config set fetch-retry-maxtimeout 120000
    - npm config set fetch-retries 5
    - npm install -g wrangler
    - wrangler --version
  script:
    - export BRANCH_NAME=$(echo "$CI_COMMIT_REF_NAME" | sed 's/\//-/g')
    - echo "Deploying PREVIEW for branch $CI_COMMIT_REF_NAME"
    - wrangler pages deploy dist/ --project-name="$CLOUDFLARE_PROJECT_NAME" --branch="$CI_COMMIT_REF_NAME" --commit-dirty=true
    - echo "SUCCESS - Preview deployment complete!"
    - echo "URL https://$BRANCH_NAME.$CLOUDFLARE_PROJECT_NAME.pages.dev"
  environment:
    name: preview/$CI_COMMIT_REF_NAME
    url: https://$CI_COMMIT_REF_SLUG.$CLOUDFLARE_PROJECT_NAME.pages.dev
  dependencies:
    - build
  rules:
    - if: '$CI_COMMIT_BRANCH != "main"'

deploy:production-manual:
  stage: deploy
  image: node:23-alpine
  before_script:
    - npm install -g wrangler
    - wrangler --version
  script:
    - echo "Manual production deployment from dev branch"
    - wrangler pages deploy dist/ --project-name="$CLOUDFLARE_PROJECT_NAME" --branch=main --commit-dirty=true
    - echo "SUCCESS - Manual production deployment complete!"
  environment:
    name: production
    url: https://formalogix.com
  dependencies:
    - build
  when: manual
  rules:
    - if: '$CI_COMMIT_BRANCH == "dev"'

deploy:api:production:
  stage: deploy
  image: bitnami/kubectl:latest
  before_script:
    - echo "Deploying API to PRODUCTION Kubernetes cluster"
    - mkdir -p ~/.kube
    - cp ${KUBECONFIG_CONTENT} ~/.kube/config
    - chmod 600 ~/.kube/config
  script:
    - export IMAGE_TAG="v${API_VERSION}-${CI_COMMIT_SHORT_SHA}"
    - export FULL_IMAGE_NAME="${DOCKER_REGISTRY}/${DOCKER_REGISTRY_IMAGE}:${IMAGE_TAG}"
    - echo "Deploying image ${FULL_IMAGE_NAME}"
    - kubectl set image deployment/formalogix-api api-server="${FULL_IMAGE_NAME}" -n "${K8S_NAMESPACE}"
    - echo "Waiting for rollout to complete..."
    - kubectl rollout status deployment/formalogix-api -n "${K8S_NAMESPACE}" --timeout=5m
    - echo "SUCCESS - API production deployment complete!"
    - kubectl get pods -n "${K8S_NAMESPACE}" -l app=formalogix-api
  environment:
    name: production-api
    url: https://forms.flickflauder.com
  needs:
    - build:api
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - api-server-go/**/*
        - .gitlab-ci.yml

deploy:api:preview:
  stage: deploy
  image: bitnami/kubectl:latest
  before_script:
    - echo "Deploying API to PREVIEW Kubernetes cluster"
    - mkdir -p ~/.kube
    - cp ${KUBECONFIG_CONTENT} ~/.kube/config
    - chmod 600 ~/.kube/config
  script:
    - export IMAGE_TAG="dev-${CI_COMMIT_SHORT_SHA}"
    - export FULL_IMAGE_NAME="${DOCKER_REGISTRY}/${DOCKER_REGISTRY_IMAGE}:${IMAGE_TAG}"
    - echo "Deploying preview image ${FULL_IMAGE_NAME}"
    - kubectl set image deployment/formalogix-api api-server="${FULL_IMAGE_NAME}" -n "${K8S_NAMESPACE}"
    - echo "Waiting for rollout to complete..."
    - kubectl rollout status deployment/formalogix-api -n "${K8S_NAMESPACE}" --timeout=5m
    - echo "SUCCESS - API preview deployment complete!"
    - kubectl get pods -n "${K8S_NAMESPACE}" -l app=formalogix-api
  environment:
    name: preview-api
    url: https://forms.flickflauder.com
  needs:
    - build:api
  rules:
    - if: '$CI_COMMIT_BRANCH == "dev"'
      changes:
        - api-server-go/**/*
        - .gitlab-ci.yml

deploy:api:production-manual:
  stage: deploy
  image: bitnami/kubectl:latest
  before_script:
    - echo "Manual API deployment to PRODUCTION"
    - mkdir -p ~/.kube
    - cp ${KUBECONFIG_CONTENT} ~/.kube/config
    - chmod 600 ~/.kube/config
  script:
    - export IMAGE_TAG="dev-${CI_COMMIT_SHORT_SHA}"
    - export FULL_IMAGE_NAME="${DOCKER_REGISTRY}/${DOCKER_REGISTRY_IMAGE}:${IMAGE_TAG}"
    - echo "Manually deploying dev image ${FULL_IMAGE_NAME} to production"
    - kubectl set image deployment/formalogix-api api-server="${FULL_IMAGE_NAME}" -n "${K8S_NAMESPACE}"
    - kubectl rollout status deployment/formalogix-api -n "${K8S_NAMESPACE}" --timeout=5m
    - echo "SUCCESS - Manual API production deployment complete!"
  environment:
    name: production-api
    url: https://forms.flickflauder.com
  needs:
    - build:api
  when: manual
  rules:
    - if: '$CI_COMMIT_BRANCH == "dev"'
