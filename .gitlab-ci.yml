# GitLab CI/CD Pipeline for Formalogix Landing Page
# Deploys Astro static site to Cloudflare Pages

stages:
  - build
  - deploy

variables:
  NODE_ENV: production
  npm_config_cache: "$CI_PROJECT_DIR/.npm"

cache:
  key:
    files:
      - package-lock.json
  paths:
    - node_modules/
    - .npm/

build:
  stage: build
  image: node:23-alpine
  before_script:
    - echo "Building for branch $CI_COMMIT_REF_NAME"
    - node --version
    - npm --version
  script:
    - |
      if [ "$CI_COMMIT_REF_NAME" = "main" ]; then
        export PUBLIC_API_URL="$PUBLIC_API_URL_PROD"
        export PUBLIC_UMAMI_WEBSITE_ID="$PUBLIC_UMAMI_WEBSITE_ID_PROD"
        echo "Building for PRODUCTION environment"
      else
        export PUBLIC_API_URL="$PUBLIC_API_URL_PREVIEW"
        export PUBLIC_UMAMI_WEBSITE_ID="$PUBLIC_UMAMI_WEBSITE_ID_PREVIEW"
        echo "Building for PREVIEW environment (branch: $CI_COMMIT_REF_NAME)"
      fi
    - npm ci --prefer-offline --no-audit
    - npm run build
    - ls -lh dist/
    - du -sh dist/
  artifacts:
    paths:
      - dist/
    expire_in: 1 day
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "dev"'
    - if: '$CI_COMMIT_BRANCH =~ /^feature\/.*/'
    - if: '$CI_COMMIT_BRANCH =~ /^fix\/.*/'

deploy:production:
  stage: deploy
  image: node:23-alpine
  before_script:
    - npm install -g wrangler
    - wrangler --version
  script:
    - echo "Deploying to PRODUCTION (formalogix.com)"
    - wrangler pages deploy dist/ --project-name="$CLOUDFLARE_PROJECT_NAME" --branch=main --commit-dirty=true
    - echo "SUCCESS - Production deployment complete!"
    - echo "URL https://formalogix.com"
  environment:
    name: production
    url: https://formalogix.com
  dependencies:
    - build
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

deploy:preview:
  stage: deploy
  image: node:23-alpine
  before_script:
    - npm install -g wrangler
    - wrangler --version
  script:
    - export BRANCH_NAME=$(echo "$CI_COMMIT_REF_NAME" | sed 's/\//-/g')
    - echo "Deploying PREVIEW for branch $CI_COMMIT_REF_NAME"
    - wrangler pages deploy dist/ --project-name="$CLOUDFLARE_PROJECT_NAME" --branch="$CI_COMMIT_REF_NAME" --commit-dirty=true
    - echo "SUCCESS - Preview deployment complete!"
    - echo "URL https://$BRANCH_NAME.$CLOUDFLARE_PROJECT_NAME.pages.dev"
  environment:
    name: preview/$CI_COMMIT_REF_NAME
    url: https://$CI_COMMIT_REF_SLUG.$CLOUDFLARE_PROJECT_NAME.pages.dev
  dependencies:
    - build
  rules:
    - if: '$CI_COMMIT_BRANCH != "main"'

deploy:production-manual:
  stage: deploy
  image: node:23-alpine
  before_script:
    - npm install -g wrangler
    - wrangler --version
  script:
    - echo "Manual production deployment from dev branch"
    - wrangler pages deploy dist/ --project-name="$CLOUDFLARE_PROJECT_NAME" --branch=main --commit-dirty=true
    - echo "SUCCESS - Manual production deployment complete!"
  environment:
    name: production
    url: https://formalogix.com
  dependencies:
    - build
  when: manual
  rules:
    - if: '$CI_COMMIT_BRANCH == "dev"'
