---
import '../styles/global.css';
import { getLocaleFromPath, getTranslations, type Locale } from '../i18n';
import { getRegionFromLocale, getPricingByRegion, formatCurrency, type Region } from '../config/pricing';

interface Props {
	title: string;
	description?: string;
	image?: string;
	url?: string;
}

// Detect locale from URL path
const currentPath = Astro.url.pathname;
const locale: Locale = getLocaleFromPath(currentPath);
const region: Region = getRegionFromLocale(locale);
const t = getTranslations(locale);

// Get regional pricing for meta tags and structured data
const pricing = getPricingByRegion(region);
const formattedAnalysisPrice = formatCurrency(pricing.analysis, pricing.currency, t.locale);
const fullServicePrice = (pricing.analysis + pricing.verification + pricing.scanning).toFixed(2);

// Default descriptions per locale (with dynamic pricing)
const defaultDescriptions = {
	de: `Handschriftliche Formulare schnell digitalisieren. KI + menschliche Verifikation = 99,8% Genauigkeit. Ab ${formattedAnalysisPrice}/Seite. ✓ DSGVO-konform ✓ API-Integration.`,
	en: `Digitize handwritten forms fast. AI + human verification = 99.8% accuracy. From ${formattedAnalysisPrice}/page. ✓ GDPR compliant ✓ API integration.`
};

// Locale-aware structured data
const organizationDescriptions = {
	de: "Automatische Konvertierung von handschriftlichen und digitalen Formularen in strukturierte Datenformate",
	en: "Automatic conversion of handwritten and digital forms into structured data formats"
};

const serviceData = {
	de: {
		catalogName: "Formularverarbeitung Services",
		selfService: {
			name: "Self-Service Formularanalyse",
			description: "KI-basierte Formularerkennung mit Selbstverifikation"
		},
		fullService: {
			name: "Full-Service Dokumentenverarbeitung",
			description: "Komplettlösung inkl. Scannen und menschlicher Verifikation"
		},
		enterprise: {
			name: "Enterprise Lösungen",
			description: "Maßgeschneiderte Integration und API-Anbindung"
		}
	},
	en: {
		catalogName: "Form Processing Services",
		selfService: {
			name: "Self-Service Form Analysis",
			description: "AI-based form recognition with self-verification"
		},
		fullService: {
			name: "Full-Service Document Processing",
			description: "Complete solution including scanning and human verification"
		},
		enterprise: {
			name: "Enterprise Solutions",
			description: "Customized integration and API connectivity"
		}
	}
};

const metaKeywords = {
	de: "handschriftliche Formulare digitalisieren, Formularerkennung Software, Datenerfassung Outsourcing, OCR Handschrift Deutsch, Versicherungsanträge digitalisieren, Prüfungsbögen auswerten, Patientenfragebögen digitalisieren DSGVO, Bestellformulare automatisch erfassen, KI Handschrifterkennung, Hybrid-Ansatz OCR",
	en: "digitize handwritten forms, form recognition software, data capture outsourcing, OCR handwriting German, digitize insurance applications, evaluate exam papers, digitize patient questionnaires GDPR, automatically capture order forms, AI handwriting recognition, hybrid OCR approach"
};

const {
	title,
	description = defaultDescriptions[locale],
	image = "/og-image.png",
	url = Astro.url.pathname
} = Astro.props;

const canonicalURL = new URL(url, Astro.site || "https://formalogix.com").href;
const ogImageURL = new URL(image, Astro.site || "https://formalogix.com").href;
const ogLocale = locale === 'de' ? 'de_DE' : 'en_US';
const alternateLocale = locale === 'de' ? 'en' : 'de';
const alternateURL = locale === 'de' ? `https://formalogix.com/en${url}` : `https://formalogix.com${url.replace('/en', '')}`;

// OG Image dimensions (1200x630 is optimal for most platforms)
const ogImageWidth = "1200";
const ogImageHeight = "630";

// Page-specific meta
const siteName = "formalogix";
const author = "formalogix Team";
const themeColor = "#1e40af"; // formalogix-blue-700

// Umami Analytics
const umamiWebsiteId = import.meta.env.PUBLIC_UMAMI_WEBSITE_ID;

// Build structured data objects
const organizationSchema = {
	"@context": "https://schema.org",
	"@type": "Organization",
	"name": "formalogix",
	"url": "https://formalogix.com",
	"logo": "https://formalogix.com/logo.png",
	"description": organizationDescriptions[locale],
	"contactPoint": {
		"@type": "ContactPoint",
		"email": "info@formalogix.com",
		"contactType": "customer service",
		"availableLanguage": ["de", "en"]
	},
	"sameAs": ["https://app.formalogix.com"]
};

const serviceSchema = {
	"@context": "https://schema.org",
	"@type": "Service",
	"serviceType": "Document Digitization and Form Recognition",
	"provider": {
		"@type": "Organization",
		"name": "formalogix"
	},
	"areaServed": {
		"@type": "Country",
		"name": "Germany"
	},
	"hasOfferCatalog": {
		"@type": "OfferCatalog",
		"name": serviceData[locale].catalogName,
		"itemListElement": [
			{
				"@type": "Offer",
				"itemOffered": {
					"@type": "Service",
					"name": serviceData[locale].selfService.name,
					"description": serviceData[locale].selfService.description
				},
				"price": pricing.analysis.toFixed(2),
				"priceCurrency": pricing.currency,
				"priceSpecification": {
					"@type": "UnitPriceSpecification",
					"price": pricing.analysis.toFixed(2),
					"priceCurrency": pricing.currency,
					"unitText": "per page"
				}
			},
			{
				"@type": "Offer",
				"itemOffered": {
					"@type": "Service",
					"name": serviceData[locale].fullService.name,
					"description": serviceData[locale].fullService.description
				},
				"price": fullServicePrice,
				"priceCurrency": pricing.currency,
				"priceSpecification": {
					"@type": "UnitPriceSpecification",
					"price": fullServicePrice,
					"priceCurrency": pricing.currency,
					"unitText": "per page"
				}
			},
			{
				"@type": "Offer",
				"itemOffered": {
					"@type": "Service",
					"name": serviceData[locale].enterprise.name,
					"description": serviceData[locale].enterprise.description
				}
			}
		]
	}
};
---

<!doctype html>
<html lang={locale}>
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta name="generator" content={Astro.generator} />

		<!-- Primary Meta Tags -->
		<title>{title}</title>
		<meta name="title" content={title} />
		<meta name="description" content={description} />
		<meta name="keywords" content={metaKeywords[locale]} />
		<meta name="author" content={author} />
		<meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1" />
		<meta name="theme-color" content={themeColor} />
		<link rel="canonical" href={canonicalURL} />

		<!-- Alternate Language Versions -->
		<link rel="alternate" hreflang={locale} href={canonicalURL} />
		<link rel="alternate" hreflang={alternateLocale} href={alternateURL} />
		<link rel="alternate" hreflang="x-default" href="https://formalogix.com/" />

		<!-- Open Graph / Facebook / WhatsApp / LinkedIn / Slack / Telegram -->
		<meta property="og:type" content="website" />
		<meta property="og:url" content={canonicalURL} />
		<meta property="og:site_name" content={siteName} />
		<meta property="og:title" content={title} />
		<meta property="og:description" content={description} />
		<meta property="og:image" content={ogImageURL} />
		<meta property="og:image:secure_url" content={ogImageURL} />
		<meta property="og:image:type" content="image/png" />
		<meta property="og:image:width" content={ogImageWidth} />
		<meta property="og:image:height" content={ogImageHeight} />
		<meta property="og:image:alt" content={title} />
		<meta property="og:locale" content={ogLocale} />
		<meta property="og:locale:alternate" content={alternateLocale === 'de' ? 'de_DE' : 'en_US'} />
		<meta property="og:site_name" content={siteName} />

		<!-- Twitter / X -->
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:site" content="@formalogix" />
		<meta name="twitter:creator" content="@formalogix" />
		<meta name="twitter:url" content={canonicalURL} />
		<meta name="twitter:title" content={title} />
		<meta name="twitter:description" content={description} />
		<meta name="twitter:image" content={ogImageURL} />
		<meta name="twitter:image:alt" content={title} />

		<!-- Mobile Browser & PWA -->
		<meta name="mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="default" />
		<meta name="apple-mobile-web-app-title" content={siteName} />
		<meta name="format-detection" content="telephone=no" />
		<meta name="msapplication-TileColor" content={themeColor} />
		<meta name="msapplication-tap-highlight" content="no" />

		<!-- Favicon -->
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />

		<!-- Fonts - Google Fonts -->
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Poppins:wght@600;700;800&display=swap" rel="stylesheet" />

		<!-- Structured Data - Organization -->
		<script type="application/ld+json" set:html={JSON.stringify(organizationSchema)} />

		<!-- Structured Data - Service -->
		<script type="application/ld+json" set:html={JSON.stringify(serviceSchema)} />

		<!-- Structured Data - SoftwareApplication -->
		<script type="application/ld+json" set:html={JSON.stringify({
			"@context": "https://schema.org",
			"@type": "SoftwareApplication",
			"name": "formalogix Form Processing API",
			"applicationCategory": "BusinessApplication",
			"operatingSystem": "Web-based, Platform independent",
			"offers": {
				"@type": "Offer",
				"price": pricing.analysis.toFixed(2),
				"priceCurrency": pricing.currency,
				"priceSpecification": {
					"@type": "UnitPriceSpecification",
					"price": pricing.analysis.toFixed(2),
					"priceCurrency": pricing.currency,
					"unitText": "per page"
				}
			},
			"featureList": "Handwriting recognition, Form recognition, API integration, 99.8% accuracy, GDPR compliant, German and English support"
		})} />
		</script>

		<!-- Structured Data - WebSite with SearchAction -->
		<script type="application/ld+json">
		{
			"@context": "https://schema.org",
			"@type": "WebSite",
			"name": "formalogix",
			"url": "https://formalogix.com",
			"potentialAction": {
				"@type": "SearchAction",
				"target": "https://formalogix.com/?s={search_term_string}",
				"query-input": "required name=search_term_string"
			}
		}
		</script>

		<!-- AI Agent Comprehensive Data Reference -->
		<link rel="alternate" type="application/json" href="/ai-business-data.json" title="AI-readable business data" />
		<meta name="ai:business_data" content="/ai-business-data.json" />
		<meta name="ai:contact_email" content="info@formalogix.com" />
		<meta name="ai:primary_service" content="Form digitization and data extraction using AI + human verification" />
		<meta name="ai:accuracy" content="99.8%" />
		<meta name="ai:turnaround" content="fast processing" />
		<meta name="ai:pricing_start" content={`${formattedAnalysisPrice} per page`} />

		<!-- Umami Analytics -->
		{umamiWebsiteId && (
			<script async defer data-website-id={umamiWebsiteId} src="https://stats.flickflauder.com/script.js"></script>
		)}
	</head>
	<body class="bg-white text-gray-900 font-body antialiased">
		<slot />
	</body>
</html>
